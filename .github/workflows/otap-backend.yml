name: Backend CI/CD (OTAP)

on:
  push:
    branches:
      - dev
      - test
      - stage
      - master

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zerosoft-technologies/eventsmap-backend

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.envname.outputs.env }}
      image_tag: ${{ steps.tags.outputs.image_tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Set environment name
        id: envname
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then echo "env=dev" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "test" ]]; then echo "env=test" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "stage" ]]; then echo "env=acc" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "master" ]]; then echo "env=production" >> $GITHUB_OUTPUT; fi

      - name: Set image tag (build once)
        id: tags
        run: |
          SHA=$(echo $GITHUB_SHA | cut -c1-8)
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "master" ]]; then TAG="latest"; else TAG="$BRANCH-$SHA"; fi
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Install PHP deps (composer)
        uses: php-actions/composer@v6
        with:
          php_version: "8.2"
          command: install --no-dev --optimize-autoloader
          progress: yes
          php_extensions: mbstring pdo pdo_mysql

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build & push image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.image_tag }}
          docker build --no-cache -t $IMAGE .
          docker push $IMAGE

      # ----- Security -----

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.image_tag }}

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.image_tag }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ needs.build.outputs.env }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy to server
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "test" ]]; then 
            TARGET_DIR="eventsmap-backend-test"
            TAG="${BRANCH}-${GITHUB_SHA:0:8}"
            COMPOSE="podman-compose.test.yml"
            CONTAINER_NAME="eventsmap-backend-test"
          fi

          if [[ "$BRANCH" == "stage" ]]; then 
            TARGET_DIR="eventsmap-backend-stage"
            TAG="${BRANCH}-${GITHUB_SHA:0:8}"
            COMPOSE="podman-compose.stage.yml"
            CONTAINER_NAME="eventsmap-backend-stage"
          fi

          if [[ "$BRANCH" == "master" ]]; then 
            TARGET_DIR="eventsmap-backend-prod"
            TAG="latest"
            COMPOSE="podman-compose.prod.yml"
            CONTAINER_NAME="eventsmap-backend-prod"
          fi

          if [[ -z "$TARGET_DIR" ]]; then 
            echo "No deploy for this branch"
            exit 0
          fi

          # Upload compose file only
          scp -P ${{ secrets.DEPLOY_PORT }} "$COMPOSE" \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }}:/home/minaxi/$TARGET_DIR/

          # Deploy via SSH - using existing .env on server
          ssh -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
            echo '${{ secrets.GHCR_PAT }}' | podman login ghcr.io -u ${{ github.actor }} --password-stdin &&
            cd /home/minaxi/$TARGET_DIR &&
            podman pull ghcr.io/${{ env.IMAGE_NAME }}:$TAG &&
            podman-compose -f $COMPOSE up -d --force-recreate &&
            podman exec -i $CONTAINER_NAME php artisan migrate --force
          "
